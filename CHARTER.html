<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Charter - Deref Patterns Project Group</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html">Welcome</a></li><li class="chapter-item expanded "><a href="CHARTER.html" class="active">Charter</a></li><li class="chapter-item expanded "><a href="meetings/index.html">Meetings</a></li><li class="chapter-item expanded "><a href="draft-rfcs/index.html">Draft RFCs</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Deref Patterns Project Group</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/rust-lang/project-deref-patterns" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>The canonical version of the charter is in the lang team repo: <a href="https://github.com/rust-lang/lang-team/blob/master/projects/deref-patterns.md">deref-patterns.md</a>.</p>
<h1 id="deref-patterns-project-group-charter"><a class="header" href="#deref-patterns-project-group-charter">Deref Patterns Project Group Charter</a></h1>
<p>Allow pattern matching through types that impl <code>Deref</code> or <code>DerefMut</code>. </p>
<h2 id="summary-and-problem-statement"><a class="header" href="#summary-and-problem-statement">Summary and problem statement</a></h2>
<p>Currently in rust, matching is blocked by bounderies like smart pointers, containers, and some wrappers. 
To solve this problem you would need to either use if let guards (unstable), or nested match/if-let. 
The former is limited to one such level, and the latter can become excessive for deeply nested types. 
To solve this, it is proposed propose that &quot;deref patterns&quot; be added, to allow for such matching to be performed.</p>
<p>An exception to the above problem, is that <code>Box&lt;T&gt;</code> can be matched with <code>feature(box_patterns)</code>. 
However, this is magic behaviour of box, and a goal of this project is to remove or reduce that magic. </p>
<p>The proposed solution has a number of unanswered questions, including the syntax for patterns, whether or not to limit to standard library types,
and how to allow exhaustive patterns soundly if not limited to standard library types. </p>
<h3 id="exhaustive-patterns-and-soundness"><a class="header" href="#exhaustive-patterns-and-soundness">Exhaustive Patterns and Soundness</a></h3>
<p>One current issue with the proposed deref patterns is that if applied generally to any type that implements <code>Deref</code>, 
it cannot soundly permit exhaustive pattern matching, as a malicious <code>Deref</code> impl could return a different value each time.
An trivial example would be  <code>Deref</code> impl that returns a static reference to an enum value that is chosen randomly
There are currently 3 different possible solutions:</p>
<ul>
<li>Do not treat deref patterns as exhausitve</li>
<li>Restrict deref patterns to (possibly a subset of) standard library types</li>
<li>Expose an unsafe lang item trait called <code>DerefPure</code>, and restrict deref patterns to implementors of that trait</li>
</ul>
<p>This initial Project Group will persue the second option, that is limiting deref patterns to a subset of standard library types. Other projects may, in the future, expand upon the work from this project to include user-provided types. The project will determine the critera for a subset needed for sound exhaustive matching, and propose an initial subset to support.</p>
<h2 id="motivation-use-cases-and-solution-sketches"><a class="header" href="#motivation-use-cases-and-solution-sketches">Motivation, use-cases, and solution sketches</a></h2>
<p>Recursive types necessarily include smart pointers, even when you could normally match through them.
For example, in a work in progress proc-macro to support restricted variadic generics, the parser needed to match &quot;fold expressions&quot;, which take the form <code>(&lt;pattern&gt; &lt;op&gt; ...)</code>. With deref patterns, this could be implemented using <code>Expr::Paren(ParenExpr{expr: Expr::Binary(ExprBinary{ left, op, right: Expr::Verbatim(t), ..}), ..})</code>. However, this is currently not possible, and required nested matches.<br />
This generalizes to any case where you need to check some pattern, but hit a deref boundery. </p>
<h2 id="prioritization"><a class="header" href="#prioritization">Prioritization</a></h2>
<p>This likely does not fit into any of the listed priorities, though it may be considered &quot;Targeted ergonomic wins and extensions&quot;.</p>
<h2 id="links-and-related-work"><a class="header" href="#links-and-related-work">Links and related work</a></h2>
<p>This has been discussed on the Rust Internals Forum at <a href="https://internals.rust-lang.org/t/somewhat-random-idea-deref-patterns/13813">https://internals.rust-lang.org/t/somewhat-random-idea-deref-patterns/13813</a>, 
as well as on zulip at <a href="https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/Deref.20patterns">https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/Deref.20patterns</a>. </p>
<p>A tracking document of all currently discussed questions and potential answers can be found here <a href="https://hackmd.io/GBTt4ptjTh219SBhDCPO4A">https://hackmd.io/GBTt4ptjTh219SBhDCPO4A</a>. </p>
<p>Prior discussions raised on the IRLO thread:</p>
<ul>
<li>https://github.com/rust-lang/rfcs/pull/462</li>
<li>https://github.com/rust-lang/rfcs/issues/2099</li>
<li>https://github.com/rust-lang/rfcs/blob/master/text/0809-box-and-in-for-stdlib.md</li>
</ul>
<h2 id="initial-people-involved"><a class="header" href="#initial-people-involved">Initial people involved</a></h2>
<p>Initially, Connor Horman and Nadriel on zulip would be involved</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="meetings/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="meetings/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
